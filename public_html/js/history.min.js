/*
 * history API JavaScript Library v3.1.3 beta
 *
 * Support: IE6+, FF3+, Opera 9+, Safari, Chrome
 *
 * Copyright 2011-2012, Dmitriy Pakhtinov ( spb.piksel@gmail.com )
 *
 * http://spb-piksel.ru/
 *
 * Dual licensed under the MIT and GPL licenses:
 *   http://www.opensource.org/licenses/mit-license.php
 *   http://www.gnu.org/licenses/gpl.html
 *
 * Update: 24-09-2012
 */
(function(e,A,r,j,U){function H(a,c,g){var d=2===a?e.onhashchange:e.onpopstate,b=2===a?"hashchange":"popstate",f=w[b];s.createEvent?(a=s.createEvent("Events"),a.initEvent(b,r,r)):(a=s.createEventObject(),a.type=b);a.state=n.state;a.oldURL=c;a.newURL=g;d&&d.call(e,a);c=0;for(g=f.length;c<g;c++)f[c].call(e,a)}function O(a){return I?a?I.setItem("__hitoryapi__",J(a)):P(I.getItem("__hitoryapi__"))||{}:{}}function Q(a,c,g){var d=a,b,f=r;if(B||C)for(b in c){if(D.call(c,b))if(C)c[b].get&&C.call(a,b,c[b].get),
c[b].set&&$.call(a,b,c[b].set);else if(B)try{B(a,b,c[b])}catch(h){if(g)return r;f=A;break}}else f=A;if(f&&x){g="StaticClass"+aa+x++;d=["Class "+g];"execVB"in e||execScript("Function execVB(c) ExecuteGlobal(c) End Function","VBScript");"VBCVal"in e||execScript("Function VBCVal(o,r) If IsObject(o) Then Set r=o Else r=o End If End Function","VBScript");for(b in a)d[d.length]="Public ["+b+"]";D.call(a,"toString")&&(a.propertyIsEnumerable("toString")||(d[d.length]="Public [toString]"),c["(toString)"]=
{get:function(){return this.toString.call(this)}});for(b in c)if(D.call(c,b)&&(c[b].get&&(a["get "+b]=c[b].get,d.push("Public [get "+b+"]","Public "+("(toString)"===b?"Default ":"")+"Property Get ["+b+"]","Call VBCVal(me.[get "+b+"].call(me),["+b+"])","End Property")),c[b].set))a["set "+b]=c[b].set,d.push("Public [set "+b+"]","Public Property Let ["+b+"](v)","Call me.[set "+b+"].call(me,v)","End Property","Public Property Set ["+b+"](v)","Call me.[set "+b+"].call(me,v)","End Property");d.push("End Class",
"Function "+g+"Factory()","Set "+g+"Factory=New "+g,"End Function");execVB(d.join("\n"));d=e[g+"Factory"]();for(b in a)d[b]=a[b];D.call(a,"toString")&&(d.toString=a.toString)}return d}var s=e.document,q=e.history||{},f=e.location,o=!!q.pushState,ba=o&&q.state===U,u=f.href,v=e.JSON||{},B=Object.defineProperty,C=Object.prototype.__defineGetter__,$=Object.prototype.__defineSetter__,V=q.pushState,W=q.replaceState,I=e.sessionStorage,D=Object.prototype.hasOwnProperty,ca=Object.prototype.toString,y=+((e.eval&&
eval("/*@cc_on 1;@*/")&&/msie (\d+)/i.exec(navigator.userAgent)||[])[1]||0),aa=(new Date).getTime(),x=(B||C)&&(!y||8<y)?0:1,i=8>y?s.createElement("iframe"):r,E,F,G,K="",L=(E="addEventListener",e[E])||(E="attachEvent",K="on",e[E]),da=(F="removeEventListener",e[F])||(F="detachEvent",e[F]),ea=(G="dispatchEvent",e[G])||(G="fireEvent",e[G]),M=[],y=[],R=0,w={onpopstate:M,popstate:M,onhashchange:y,hashchange:y},t=function(){var a,c,g,d={basepath:"/",redirect:0,type:"/"};g=s.getElementsByTagName("SCRIPT");
for(a=0;g[a];a++)if(c=/(.*)\/(?:history|spike)(?:-\d\.\d(?:\.\d)?\w?)?(?:\.min)?.js\?(.*)$/i.exec(g[a].src)||a===g.length-1&&2===(c=g[a].src.split("?")).length&&(c[2]=c[1])&&c){a=0;for(g=c[2].split("&");g[a];)c=g[a++].split("="),d[c[0]]="true"==c[1]?A:"false"==c[1]?r:c[1]||"";d.basepath=d.basepath||"/";break}return d}(),l=function(a){var c,g,d,b,e,h,p,i=RegExp("^"+t.basepath,"i");return function(k,j){if(k){if(!o)var m=l(),S=m.f,Y=m.i,k=/^(?:[a-z]+\:)?\/\//.test(k)?0===k.indexOf("/")?Y+k:k:Y+"//"+
m.h+(0===k.indexOf("/")?k:0===k.indexOf("?")?S+k:0===k.indexOf("#")?S+m.g+k:S.replace(/[^\/]+$/g,"")+k)}else if(k=f.href,!o||j)k=f.protocol+"//"+f.host+t.basepath+(k.replace(/^[^#]*/,"")||"#").replace(RegExp("^#[/]?(?:"+t.type+")?"),"");if(c!==k){a.href=c=k;h=a.port;e=a.host;p=a.pathname;if("http:"===a.protocol&&80==h||"https:"===a.protocol&&443==h)e=a.hostname,h="";p=0===p.indexOf("/")?p:"/"+p;g=p+a.search+a.hash;b=p.replace(i,t.type)+a.search;d=b+a.hash}return{a:a.protocol+"//"+e+g,i:a.protocol,
h:e,j:a.hostname||f.hostname,k:h||f.port,f:p,g:a.search,e:a.hash,b:g,c:b,d:d}}}(s.createElement("a")),n=!x?q:{back:q.back,forward:q.forward,go:q.go,pushState:j,replaceState:j,emulate:!o,toString:function(){return"[object History]"}},N={state:{get:function(){return i&&i.storage||O()[n.location.href]||j}},length:{get:function(){return q.length}},location:{set:function(a){e.location=a},get:function(){return o?f:T}}},T={assign:function(a){f.assign(o||0!==a.indexOf("#")?a:"#"+l().c+a)},reload:f.reload,
replace:function(a){f.replace(o||0!==a.indexOf("#")?a:"#"+l().c+a)},toString:function(){return this.href}},fa={href:{set:function(a){f.href=a},get:function(){return l().a}},protocol:{set:function(a){f.protocol=a},get:function(){return f.protocol}},host:{set:function(a){f.host=a},get:function(){return f.host}},hostname:{set:function(a){f.hostname=a},get:function(){return f.hostname}},port:{set:function(a){f.port=a},get:function(){return f.port}},pathname:{set:function(a){f.pathname=a},get:function(){return l().f}},
search:{set:function(a){f.search=a},get:function(){return l().g}},hash:{set:function(a){var a=0===a.indexOf("#")?a:"#"+a,c=l();i?a!=c.e&&(n.pushState(j,j,c.c+a),Z({oldURL:c.a})):f.hash="#"+c.c+a},get:function(){return l().e}}},J=v.stringify||function(a){function c(d){var b,f,h;b=(typeof d).charCodeAt(2);if(114===b)d=e(d);else if(109===b)d=isFinite(d)?""+d:"null";else if(111===b||108===b)d=""+d;else if(106===b)if(d){f=(b="[object Array]"===ca.apply(d))?"[":"{";if(b)for(h=0;h<d.length;h++)f+=(0==h?
"":",")+c(d[h]);else for(h in d)D.call(d,h)&&d[h]!==a&&(f+=(1==f.length?"":",")+e(h)+":"+c(d[h]));d=f+(b?"]":"}")}else d="null";else d=a;return d}function e(a){var b=/[\\\"\u0000-\u001f\u007f-\u009f\u00ad\u0600-\u0604\u070f\u17b4\u17b5\u200c-\u200f\u2028-\u202f\u2060-\u206f\ufeff\ufff0-\uffff]/g,c={"\u0008":"\\b","\t":"\\t","\n":"\\n","\u000c":"\\f","\r":"\\r",'"':'\\"',"\\":"\\\\"};b.lastIndex=0;return b.test(a)?'"'+a.replace(b,function(a){var b=c[a];return"string"===typeof b?b:"\\u"+("0000"+a.charCodeAt(0).toString(16)).slice(-4)})+
'"':'"'+a+'"'}return c}(),P=function(){var a=v.parse;return function(c){return c?a?a(c):(new Function("return "+c))():j}}(),Z=function(){function a(a){var c=l();if(R)return p=c.a,R=0;var d=a.oldURL||p,a=p=a.newURL||c.a,c=d.replace(/^.*?(#|$)/,""),f=a.replace(/^.*?(#|$)/,"");d!=a&&!b&&H();u=b=0;c!=f&&H(2,d,a)}function c(){if(u&&!(u=0)&&h.b!==t.basepath)clearInterval(i),setTimeout(H,10)}var g=e.onpopstate||j,d=e.onhashchange||j,b=0,i=j,h=l(),p=h.a;h.e.replace(/^#/,"");L(K+"hashchange",a,r);L(K+"popstate",
function(){if(u===f.href)return u=0;u=0;H(b=1)},r);n.fixURL=function(a){return l(a).b};n=Q(n,x?N:q.state===U?{state:N.state,location:N.location}:{location:N.location});T=Q(T,fa);e[E]=function(a,b,d,f){w[a]?(w[a].push(b),!o&&M===w[a]&&c()):L(a,b,d,f)};e[F]=function(a,b,c){var d=w[a];if(d)for(a=d.length;--a;){if(d[a]===b){d.splice(a,1);break}}else da(a,b,c)};e[G]=function(a,b){var c=w[a],d=c===M?e.onpopstate:e.onhashchange;if(c){b=b||("string"==typeof a?e.event:a);try{b&&(b.target=e)}catch(f){try{b.srcElement=
e}catch(g){}}d&&d.call(e,b);for(var d=0,h=c.length;d<h;d++)c[d].call(e,b);return A}return ea(a,b)};x&&execScript("Public history, onhashchange","VBScript");if((!B&&!C||!Q(e,{onhashchange:{get:function(){return d},set:function(a){d=a||j}},onpopstate:{get:function(){return g},set:function(a){(g=a||j)&&!o&&c()}}},1))&&!o)i=setInterval(function(){e.onpopstate&&c()},100);if(t.redirect&&e.top==e.self){var X=l(j,A).b,k=f.search,z=f.pathname,m=t.basepath;o?(X!=m&&RegExp("^"+m+"$","i").test(z)&&(f.href=X),
RegExp("^"+m+"$","i").test(z+"/"))?f.href=m:RegExp("^"+m,"i").test(z)||(f.href=z.replace(/^\//,m)+k):z!=m&&(f.href=m+"#"+z.replace(RegExp("^"+m,"i"),t.type)+k+f.hash)}return a}();n.pushState=function(a,c,e,d){var b=O(),i=l().a,h=e&&l(e);u=0;e=h?h.a:i;d&&b[i]&&delete b[i];if((!o||ba)&&I&&a)b[e]=a,O(b),a=j;V&&W?d?W.call(n,a,c,e):V.call(n,a,c,e):h&&h.b!=l().b&&(R=1,d?f.replace("#"+h.d):f.hash=h.d)};n.replaceState=function(a,c,e){n.pushState(a,c,e,1)};x?(e.history=n,function(a,c){if(i){var g,d,b=function(){var a=
l().a;c!=a&&Z({oldURL:c,newURL:c=a})};d=setInterval(b,100);i.src="javascript:true;";i=s.documentElement.firstChild.appendChild(i).contentWindow;n.pushState=g=function(a,e,j,k,n){var m=i.document,o=["<script>","lfirst=1;",,"storage="+J(a)+";","<\/script>"];if(j=j&&l(j)){n||clearInterval(d);if(k)i.lfirst?(history.back(),g(a,e,j.a,0,1)):(i.storage=a,f.replace("#"+j.d));else if(j.a!=c||n)i.lfirst||(i.lfirst=1,g(i.storage,e,c,0,1)),o[2]='parent.location.hash="'+j.d.replace(/"/g,'\\"')+'";',m.open(),m.write(o.join("")),
m.close();n||(c=l().a,d=setInterval(b,100))}else i.storage=a};L(K+"unload",function(){if(i.storage){var a={};a[l().a]=i.storage;s.cookie="_historyAPI="+escape(J(a))}clearInterval(d)},r);if(1<a.length){a=unescape(a.pop().split(";").shift());try{i.storage=P(a)[l().a]}catch(j){}}!v.parse&&!v.stringify&&(v.parse=P,v.stringify=J,e.JSON=v)}}(s.cookie.split("_historyAPI="),l().a)):e.history.emulate=!o})(window,!0,!1,null);
